<!DOCTYPE html>
<meta charset="utf-8">
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="css/style.css" />
        <title>Timeness</title>
        <style> body { padding-top: 100px; } </style>
    </head>
    <body>

            <div class="container">
                <div class="row">
                   <h1>Timeness</h1> 
                </div>
            </div> 

            <div class="container">
                <div class="row">                           
                    <label for="delimiter">Exibir limites de tempo</label>
                    <input name="delimiter" type="checkbox" checked="true" onchange="updateDelimiter()">
                </div>
            </div>

            <div class="container">
                <div class="row">                           
                    <button type="button" class="btn btn-primary" onclick="addLine()">Adicionar linha</button>
                    <button type="button" class="btn btn-primary" onclick="removeLine()">Remover linha</button>
                    <button type="button" class="btn btn-primary" onclick="graph(element)">Reset zoom</button>
                </div>
            </div>
            <!--  -->
            <!--  -->
            <!--  -->
            <div class="container">
                <div class="row">
                    <div class="col-lg-12" id="chart_placeholder"> </div>
                </div> <!--row-->
            </div><!-- /.container -->
            <!--  -->
            <!--  -->
            <div class="container">
                <div class="row">
                   <h1>Timeless</h1> 
                </div>
            </div> 
            <!--  -->
            <div class="container">
                <div class="row">
                    <div class="col-lg-12" id="chart_placeholder2"> </div>
                </div> <!--row-->
            </div><!-- /.container -->
            <!--  -->
            <!--  -->
            <!--  -->

            <div class="container">
                <div class="row">
                    <div id="legend"></div>
                </div>
            </div>


            <div class="container">
                <div class="row">
                    <div id="zoomEnd"></div>
                </div>
            </div>


                    <script src="js/jquery-1.11.1.min.js"></script>
                    <script src="js/bootstrap.min.js"></script>
                    <script src="js/d3.v3.min.js"></script>
                    <script src="js/eventDrops.js"></script>
                    <script>

        d3.json("js/data.json", function(error, data){
            // Thats ugly, but required by CSRF security...
            data = data.data;

            // Converting strings to Date
            data.forEach(function(stream){
                stream.dates = stream.dates.map(function(time){
                    return new Date(time);    
                });
            });

            var eventDropsChart = d3.chart.eventDrops()
                                    .axisFormat(function(xAxis) { xAxis.ticks(5); });
            d3.select('#chart_placeholder2').datum(data).call(eventDropsChart);
        });


                    var chartPlaceholder = document.getElementById('chart_placeholder');
                    var eventNames = ["Matemática",
                    "Física",
                    "Artes plásticas",
                    "Política",
                    "Catástrofes",
                    "Ends of the world"];
                    var data = [];
                    var endTime = Date.now();
                    var oneMonth = 30 * 24 * 60 * 60 * 1000;
                    var startTime = endTime - oneMonth;
                    var middleTime = startTime + ((endTime - startTime) / 2);
                    // =============================================================================
                    // =============================================================================
                    var indebugmode = true;
                    // -----------------------------------------------------------------------------
                    function createEvent_temp_func (name) {
                    var event = {};
                    event.name = name;
                    event.dates = [];
                    var max =  Math.floor(Math.random() * 200);
                    for (var j = 0; j < max; j++) {
                    var time = Math.floor((Math.random() * oneMonth)) +
                    startTime;
                    event.dates.push(new Date(time));
                    }
                    return event;
                    }
                    // -----------------------------------------------------------------------------
                    //function createEvent (name) {
                    //
                    // }
                    // -----------------------------------------------------------------------------
                    if(indebugmode){
                    for (var i = 0; i < 6; i++) {
                    data.push(createEvent_temp_func(eventNames[i]));
                    }
                    }else{
                    for (var i = 0; i < 6; i++) {
                    data.push(createEvent(eventNames[i]));
                    }
                    }
                    // =============================================================================
                    // =============================================================================
                    
                    var color = d3.scale.category20();
                    var locale = d3.locale({
                    "decimal": ".",
                    "thousands": " ",
                    "grouping": [3],
                    "dateTime": "%A %e %B %Y, %X",
                    "date": "%d/%m/%Y",
                    "time": "%H:%M",
                    "periods": ["AM", "PM"],
                    "days": ["domingo", "segunda-feira", "terça-feira", "quarta-feira", "quinta-feira", "sexta-feira", "sábado"],
                    "shortDays": ["dom.", "seg.", "ter.", "qua.", "qui.", "sex.", "sab."],
                    'months': ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'agosto', 'novembro', 'dezembro'],
                    'shortMonths': ['jan.', 'fev.', 'mar.', 'abr.', 'mai.', 'jun.', 'jul.', 'ago.', 'set.', 'out.', 'nov.', 'dec.']
                    });
                    var graph = d3.chart.eventDrops()
                    .start(new Date(startTime))
                    .end(new Date(endTime))
                    .minScale(0.5)
                    .maxScale(100)
                    .locale(locale)
                    .eventColor(function (datum, index) {
                    if (datum.getTime() < middleTime) {
                    return 'green';
                    }
                    return 'red';
                    })
                    .width(800)
                    .margin({ top: 100, left: 200, bottom: 0, right: 0 })
                    .axisFormat(function(xAxis) {
                    xAxis.ticks(5);
                    })
                    .eventHover(function(el) {
                    var linha = el.parentNode.firstChild.innerHTML;
                    var timestamp = d3.select(el).data()[0];
                    document.getElementById('legend').innerHTML = 'Mouse sobre [' + timestamp + '] na série "' + linha + '"';
                    })
                    .eventZoom(function (scale) {
                    var limit = scale.domain();
                    var period = parseInt((limit[1] - limit[0]) / (60 * 60 * 1000) );
                    document.getElementById('zoomEnd').innerHTML = 'Zoom cobrindo um período de "' + period + ' horas"';
                    });
                    /*                .eventClick(function (el) {
                    console.log('clicked');
                    });*/
                    var element = d3.select(chartPlaceholder).append('div').datum(data);
                    graph(element);
                    var updateDelimiter = function (value) {
                    graph.hasDelimiter(!graph.hasDelimiter())(element);
                    };
                    var addLine = function () {
                    var data = element.datum();
                    var i = data.length;
                    data.push(createEvent_temp_func(eventNames[i]));
                    elements = element.datum(data);
                    graph(element);
                    };
                    var removeLine = function () {
                    var data = element.datum();
                    data.pop();
                    element = element.datum(data);
                    graph(element);
                    };
                    </script>
                </body>
            </html>